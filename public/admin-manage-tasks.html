<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Manage Tasks (GitHub Storage)</title>
  <link rel="stylesheet" href="getcash.css">
  <script src="github-storage.js"></script>
  <style>
    .admin-view-container {
      max-width: 1200px;
      margin: 40px auto 100px auto;
      padding: 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    
    .storage-info {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    
    .btn-danger:hover {
      background: #ff3838;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-secondary {
      background: #667eea;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a67d8;
    }
    
    .tasks-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .tasks-table th {
      background: #f8faff;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      border-bottom: 2px solid #e0eaff;
    }
    
    .tasks-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .tasks-table tr:hover {
      background: #f8faff;
    }
    
    .tasks-table img {
      max-width: 80px;
      max-height: 80px;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .tasks-table img:hover {
      transform: scale(1.1);
    }
    
    .delete-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s ease;
    }
    
    .delete-btn:hover {
      background: #ff3838;
    }
    
    .loading, .no-tasks {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .no-tasks {
      font-style: italic;
    }
    
    .task-count {
      background: #e3f2fd;
      color: #1976d2;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-left: 10px;
    }
    
    .token-setup {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="admin-view-container">
    <h2>üîó Manage Tasks (GitHub Storage) <span id="taskCount" class="task-count">Loading...</span></h2>
    
    <div class="storage-info">
      <strong>‚ú® GitHub Storage Active</strong><br>
      Unlimited tasks ‚Ä¢ Global access ‚Ä¢ Full image quality ‚Ä¢ No quotas ‚Ä¢ Persistent storage
    </div>

    <div id="tokenSetup" class="token-setup" style="display: none;">
      <h3>üîë GitHub Token Required</h3>
      <p>To manage tasks, please provide your GitHub Personal Access Token:</p>
      <ol>
        <li>Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Tokens</a></li>
        <li>Generate new token with "repo" permissions</li>
        <li>Copy and paste below:</li>
      </ol>
      <input type="password" id="tokenInput" placeholder="Paste GitHub token here" style="width: 300px; padding: 8px;">
      <button onclick="setupToken()" class="btn btn-primary" style="margin-left: 10px;">Save Token</button>
    </div>
    
    <div class="controls">
      <button onclick="loadTasks()" class="btn btn-primary">
        üîÑ Refresh Tasks
      </button>
      <button onclick="window.location.href='task-upload-github.html'" class="btn btn-secondary">
        ‚ûï Upload New Task
      </button>
      <button onclick="window.location.href='admin-approvals.html'" class="btn btn-primary" style="background: #28a745;">
        üëë Admin Approvals
      </button>
      <button onclick="window.location.href='admin-wallet.html'" class="btn btn-primary" style="background: #17a2b8;">
        üí∞ Wallet Management
      </button>
      <button onclick="deleteAllTasks()" class="btn btn-danger" id="deleteAllBtn">
        üóëÔ∏è Delete All Tasks
      </button>
      <button onclick="window.location.href='getcash.html'" class="btn btn-secondary">
        ‚Üê Back to Dashboard
      </button>
      <button onclick="clearLocalStorage()" class="btn btn-danger" style="background: #ff6b6b;">
        üßπ Clear localStorage
      </button>
    </div>

    <table class="tasks-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Description</th>
          <th>Reward</th>
          <th>Image</th>
          <th>Upload Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tasksTableBody">
        <tr>
          <td colspan="7" class="loading">üîÑ Loading tasks from GitHub...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    let allTasks = [];
    let isTokenSet = false;

    // Initialize on page load
    window.addEventListener('load', async function() {
      await checkGitHubToken();
      if (isTokenSet) {
        await loadTasks();
      }
    });

    async function checkGitHubToken() {
      const savedToken = localStorage.getItem('github_token');
      if (!savedToken) {
        document.getElementById('tokenSetup').style.display = 'block';
        return false;
      } else {
        githubStorage.setToken(savedToken);
        isTokenSet = true;
        return true;
      }
    }

    function setupToken() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        alert('Please enter a valid GitHub token');
        return;
      }

      githubStorage.setToken(token);
      document.getElementById('tokenSetup').style.display = 'none';
      isTokenSet = true;
      loadTasks();
      alert('‚úÖ GitHub token saved! You can now manage tasks.');
    }

    async function loadTasks() {
      if (!isTokenSet && !await checkGitHubToken()) {
        return;
      }

      const tableBody = document.getElementById('tasksTableBody');
      const taskCount = document.getElementById('taskCount');
      
      tableBody.innerHTML = '<tr><td colspan="7" class="loading">üîÑ Loading tasks from GitHub...</td></tr>';
      taskCount.textContent = 'Loading...';

      try {
        allTasks = await githubStorage.getTasks();
        console.log('üìã Loaded', allTasks.length, 'tasks from GitHub');
        displayTasks();
        taskCount.textContent = `${allTasks.length} tasks`;
      } catch (error) {
        console.error('‚ùå Error loading tasks:', error);
        tableBody.innerHTML = `<tr><td colspan="7" style="color: red; text-align: center; padding: 20px;">‚ùå Failed to load tasks: ${error.message}</td></tr>`;
        taskCount.textContent = 'Error';
      }
    }

    function displayTasks() {
      const tableBody = document.getElementById('tasksTableBody');
      
      if (allTasks.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="no-tasks">üìù No tasks found.<br><a href="task-upload-github.html">Upload your first task</a></td></tr>';
        return;
      }

      tableBody.innerHTML = allTasks.map((task, index) => `
        <tr>
          <td><strong>${index + 1}</strong></td>
          <td><strong>${task.title || 'Untitled'}</strong></td>
          <td>${task.description ? (task.description.length > 100 ? task.description.substring(0, 100) + '...' : task.description) : 'No description'}</td>
          <td style="color: #4CAF50; font-weight: bold;">$${task.reward || '0'}</td>
          <td>
            ${task.img ? 
              `<img src="${task.img}" alt="Task image" onclick="showImageModal('${task.img}')" title="Click to view full size">` : 
              '<span style="color: #999;">üì∑ No image</span>'
            }
          </td>
          <td>${formatDate(task.uploadDate)}</td>
          <td>
            <button onclick="deleteTask('${task.id}')" class="delete-btn" title="Delete this task">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function deleteTask(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const confirmed = confirm(`üóëÔ∏è Delete "${task.title}"?\n\nThis will permanently remove the task from GitHub storage.\nThis action cannot be undone.`);
      if (!confirmed) return;

      try {
        await githubStorage.deleteTask(taskId);
        await loadTasks(); // Reload to refresh display
        alert('‚úÖ Task deleted successfully!');
      } catch (error) {
        console.error('Delete failed:', error);
        alert('‚ùå Failed to delete task: ' + error.message);
      }
    }

    async function deleteAllTasks() {
      if (allTasks.length === 0) {
        alert('üìù No tasks to delete!');
        return;
      }

      const warning = `üö® DELETE ALL ${allTasks.length} TASKS?\n\nThis will permanently delete ALL tasks from GitHub storage.\n\n‚ö†Ô∏è THIS ACTION CANNOT BE UNDONE! ‚ö†Ô∏è\n\nAre you absolutely sure?`;
      
      if (!confirm(warning)) return;

      const confirmation = prompt('Type "DELETE ALL TASKS" to confirm this destructive action:');
      if (confirmation !== 'DELETE ALL TASKS') {
        alert('‚ùå Deletion cancelled - confirmation text did not match.');
        return;
      }

      const deleteBtn = document.getElementById('deleteAllBtn');
      const originalText = deleteBtn.textContent;
      deleteBtn.textContent = 'üîÑ Deleting...';
      deleteBtn.disabled = true;

      try {
        await githubStorage.deleteAllTasks();
        await loadTasks(); // Reload to refresh display
        alert('‚úÖ All tasks deleted successfully!');
      } catch (error) {
        console.error('Delete all failed:', error);
        alert('‚ùå Failed to delete all tasks: ' + error.message);
      } finally {
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
      }
    }

    function formatDate(dateString) {
      if (!dateString) return 'Unknown';
      const date = new Date(dateString);
      return date.toLocaleDateString() + '<br><small>' + date.toLocaleTimeString() + '</small>';
    }

    function showImageModal(imageSrc) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        cursor: pointer;
      `;
      
      const img = document.createElement('img');
      img.src = imageSrc;
      img.style.cssText = `
        max-width: 95%;
        max-height: 95%;
        border-radius: 8px;
        box-shadow: 0 4px 30px rgba(0,0,0,0.5);
      `;
      
      const closeText = document.createElement('div');
      closeText.style.cssText = `
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 30px;
        font-weight: bold;
      `;
      closeText.textContent = '√ó';
      
      modal.appendChild(img);
      modal.appendChild(closeText);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    }
    
    // Clear all localStorage data
    function clearLocalStorage() {
      const confirmed = confirm('üóëÔ∏è CLEAR ALL LOCALSTORAGE?\n\nThis will permanently delete:\n‚Ä¢ All cached tasks\n‚Ä¢ User preferences  \n‚Ä¢ Login sessions\n‚Ä¢ Any locally stored data\n\n‚ö†Ô∏è This action cannot be undone!\n\nAre you sure?');
      
      if (!confirmed) return;
      
      const doubleConfirm = prompt('Type "CLEAR ALL" to confirm this action:');
      if (doubleConfirm !== 'CLEAR ALL') {
        alert('‚ùå Action cancelled - confirmation text did not match.');
        return;
      }
      
      try {
        // Get current storage size before clearing
        const sizeBefore = getCurrentLocalStorageSize();
        
        // Clear all localStorage
        localStorage.clear();
        
        console.log('üßπ localStorage cleared completely');
        console.log('üìä Storage freed:', (sizeBefore / 1024).toFixed(2) + 'KB');
        
        alert(`‚úÖ localStorage cleared successfully!\n\nüìä Freed ${(sizeBefore / 1024).toFixed(2)}KB of storage space.\n\nPage will reload to reflect changes.`);
        
        // Reload page to reflect changes
        window.location.reload();
      } catch (error) {
        console.error('‚ùå Error clearing localStorage:', error);
        alert('‚ùå Failed to clear localStorage: ' + error.message);
      }
    }
    
    // Helper function to calculate localStorage size
    function getCurrentLocalStorageSize() {
      let total = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          total += localStorage[key].length + key.length;
        }
      }
      return total;
    }
  </script>
</body>
</html>